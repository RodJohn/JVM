

https://blog.csdn.net/u013132035/article/details/78598979



javac编译器工作流程


1、词法分析

    定义：词法分析是将源代码的字符流转变为标记（Token）集合，单个字符是程序编写的最小元素，而标记是编译过程的最小元素。如：关键字、变量名、字面量、运算符都能成为标记。
    解析类：com.sun.tools.javac.parser.Scanner

读取源代码，一个字节一个字节的读取，找出其中我们定义好的关键字（如java中的if else for等关键字，识别哪些if是合法的关键字，哪些不是），这就是词法分析器进行词法分析的过程，其结果是从源代码中找出规范化的Token流。
2、语法分析

    定义：语法分析是根据Token序列构造抽象语法树的过程，抽象语法树（AST）是一种用来描述程序代码中的一个语法结构，如包、类型、修饰符、运算符、接口、返回值等。
    解析类：com.sun.tools.javac.parser.JavacParser

通过语法分析器对词法分析后Token流进行语法分析，这一步检查这些关键字组合再一次是否符合java语言规范（如在if后面是不是紧跟着一个布尔判断表达式），词法分析的结果是形成一个符合java语言规范的抽象语法树。
3、填充符号表

（1）定义：符号表（Symbol Table）是一组符号地址与符号信息构成的表格。

（2）符号表中记录的信息在编译的不同阶段都要用到，如：语义分析时，符号表中的内容用于语义检查（名字与原先的说明是否一致）与生成中间代码；在目标代码生成阶段，对地址名进行地址分配就是根据符号表的记录。

（3）解析类：com.sun.tools.javac.comp.Enter
4、注解处理器

（1）JDK1.5，java语言提供了注解的支持，但当时只能在运行期发挥作用。

（2）JDK 1.6，提供了插入式注解处理器的标准API在编译期间对注解进行处理。这些注解处理器能在处理注解期

间对语法树进行修改，所以需要回到解析以及填充符号表的过程，这称为一个Round。

（3）处理类：com.sun.tools.javac.processing.JavacProcessingEnvironment
5、语义分析:分析对结构正确的源程序进行上下文有关性质的审查：如类型审查

通过语义分析器进行语义分析。语音分析主要是将一些难懂的、复杂的语法转化成更加简单的语法，结果形成最简单的语法（如将foreach转换成for循环、注解等），最后形成一个注解过后的抽象语法树，这个语法树更为接近目标语言的语法规则。

（1）标注检查

检查内容：变量使用前是否被声明、变量与赋值之间的数据类型是否能匹配等

常量折叠：常量相加变为一个常量

例子：int a = 1 + 2; => int a = 3;

解析类：com.sun.tools.javac.comp.Attr、com.sun.tools.javac.comp.Check

（2）数据及控制流分析

数据及控制流分析是对程序上下文逻辑更进一步的验证

验证内容：局部变量在使用前是否赋值、方法的每条路径是否有返回值、是否所有的受检异常被正确处理。

例子：final 只在编译期间保证变量的不变性

解析类：com.sun.tools.javac.comp.Flow

（3）解语法糖

语法糖：JVM不支持的语法，但为了让程序员编程简单而添加的高级语法，所以编译过程需要将高级语法还原

为简单的基础语法结构。

例子：增强for循环 => 迭代器循环

解析类：com.sun.tools.javac.comp.TransTypes 、com.sun.tools.javac.comp.Lower
6、中间代码生成

通过字节码生产器将经过注解的抽象语法树转化成符合jvm规范的字节码。
该中间表示有两个重要的性质：

    易于生成；
    能够轻松地翻译为目标机器上的语言。

在Java中，javac执行的结果就是得到一个字节码，而这个字节码其实就是一种中间代码。

著名的解语法糖操作，也是在javac中完成的。

    前面各个步骤的信息（语法树、符号表）转化为字节码写入磁盘
    少量的添加和转换工作

    如：字符串加法 => StringBuilder的append方法；
    如：类构造器和实例构造器的生成（顺序为父类的构造器先执行）

    关联类：com.sun.tools.javac.jvm.Gen、com.sun.tools.javac.jvm.ClassWriter


